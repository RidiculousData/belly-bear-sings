rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to get user permissions document
    function getUserPermissions() {
      return get(/databases/$(database)/documents/userPermissions/$(request.auth.uid));
    }
    
    // Helper function to check if user has tenant access (multi-tenancy)
    function hasTenantAccess(tenant) {
      // All authenticated users have access to their tenant
      // Permission checking can be added here for stricter control
      return isAuthenticated();
    }
    
    // User permissions collection - global, not tenant-specific
    match /userPermissions/{userId} {
      allow read, write: if request.auth != null;
    }
    
    // Multi-tenant collections (dev, test, prod are separate tenants)
    match /tenants/{tenant} {
      match /{document=**} {
        allow read, write: if request.auth != null;
      }
    }
  }
}
